<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyDigitalHub - Digital Subscriptions</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Expose public key globally (so diagnostics and other scripts can read it).
       WARNING: avoid committing live keys to public repos. Use test key in dev. -->
  <script>
    window.INTASEND_PUBLIC_KEY = 'ISPubKey_live_908361d5-cdb8-4590-98cc-06dc4889cbb9';
    console.log('INTASEND_PUBLIC_KEY set on window (hidden in production).');
  </script>

  <!-- Primary IntaSend inline SDK attempt -->
  <script src="https://js.intasend.com/intasend-inline.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <img src="assets/logo.png" alt="MyDigitalHub logo" class="h-10 w-10 object-cover rounded-md"/>
      <h1 class="text-2xl font-bold text-blue-600">MyDigitalHub</h1>
    </div>
    <nav class="hidden md:flex items-center gap-4">
      <a href="#" class="px-4 text-gray-700 hover:text-blue-500">Home</a>
      <a href="#products" class="px-4 text-gray-700 hover:text-blue-500">Products</a>
      <a href="#contact" class="px-4 text-gray-700 hover:text-blue-500">Contact</a>

      <!-- Diagnostic button -->
      <button
        id="run-diagnostic"
        onclick="runPaymentDiagnostic && runPaymentDiagnostic()"
        class="ml-4 bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-2 px-3 rounded"
        title="Run quick payment integration diagnostics"
      >Run Payment Diagnostic</button>
    </nav>
  </header>

  <!-- Hero Section -->
  <main class="p-6 flex-1">
    <section class="text-center mb-6">
      <h2 class="text-3xl font-bold mb-2 text-blue-600">Your One-Stop Shop for Digital Subscriptions</h2>
      <p class="text-gray-600">Affordable plans, IntaSend secure checkout in USD!</p>
    </section>

    <!-- Product Grid -->
    <section id="products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 p-6"></section>

    <!-- Contact Form -->
    <section id="contact" class="max-w-xl mx-auto mt-12 bg-white rounded shadow p-6">
      <h3 class="text-lg font-bold text-blue-600 mb-4">Contact Us</h3>
      <form id="contact-form" class="flex flex-col gap-4">
        <input type="text" name="name" placeholder="Your Name" required class="border p-2 rounded"/>
        <input type="email" name="email" placeholder="Your Email" required class="border p-2 rounded"/>
        <textarea name="message" placeholder="Your Message" required class="border p-2 rounded"></textarea>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Send</button>
        <p id="contact-status" class="text-green-600 text-sm mt-2 hidden"></p>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white p-6 text-center mt-10 border-t">
    <p class="text-gray-600">Contact us on WhatsApp: <a href="https://wa.me/254757780414" class="text-blue-500 underline">+254757780414</a></p>
    <p class="text-sm text-gray-400 mt-2">&copy; 2025 MyDigitalHub</p>
  </footer>

  <!-- Debug / JavaScript -->
  <script>
    // Products (unchanged)
    const products = [
      { name: 'DSTV Stream', price: 6.00, description: 'Stream live DSTV channels for 1 month.', image: 'assets/dstv.jpg' },
      { name: 'Startimes ON', price: 9.80, description: 'Watch live channels without monthly subscription.', image: 'assets/startimes.jpg' },
      { name: 'Sports TV', price: 8.50, description: 'Unlimited sports coverage including EPL, La Liga, and more.', image: 'assets/sports.jpg' },
      { name: 'Movies & Series App', price: 9.00, description: 'Unlimited access to trending movies and TV series.', image: 'assets/movies.jpg' },
      { name: 'YouTube Premium', price: 5.50, description: 'Ad-free YouTube experience with offline viewing.', image: 'assets/youtube.jpg' },
      { name: 'TikTok 18+', price: 4.00, description: 'Exclusive access to 18+ content on TikTok.', image: 'assets/tiktok.jpg' }
    ];

    // If the code expects INTASEND_PUBLIC_KEY as a constant, ensure it falls back to the window value
    const INTASEND_PUBLIC_KEY = (typeof window !== 'undefined' && window.INTASEND_PUBLIC_KEY) ? window.INTASEND_PUBLIC_KEY : 'ISPubKey_live_908361d5-cdb8-4590-98cc-06dc4889cbb9';

    // Create product HTML
    function createProductCard(product, index) {
      return `
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col">
          <img src="${product.image}" alt="${product.name}" class="w-full h-40 object-cover rounded-md mb-2">
          <h3 class="text-lg font-semibold">${product.name}</h3>
          <p class="text-sm text-gray-500 mb-2">$${product.price.toFixed(2)}</p>
          <p class="text-sm mb-4">${product.description}</p>

          <label for="email-input-${index}" class="text-sm text-gray-600 mb-1">Enter email for receipt</label>
          <input
            type="email"
            id="email-input-${index}"
            placeholder="you@example.com"
            class="border p-2 rounded mb-3 w-full"
            oninput="validateEmailInput(${index})"
            aria-label="customer email"
          />

          <button
            id="pay-btn-${index}"
            onclick="payWithIntaSend('${escapeJsString(product.name)}', ${product.price}, ${index})"
            class="mt-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full disabled:opacity-50"
            disabled
          >
            Pay $${product.price.toFixed(2)}
          </button>

          <p id="status-${index}" class="text-xs text-red-600 mt-2 hidden"></p>
        </div>
      `;
    }

    function renderProducts() {
      const container = document.getElementById('products');
      container.innerHTML = products.map((p, i) => createProductCard(p, i)).join('');
    }

    // Email validation
    window.validateEmailInput = function(index) {
      const emailInput = document.getElementById(`email-input-${index}`);
      const payBtn = document.getElementById(`pay-btn-${index}`);
      if (validateEmail(emailInput.value)) payBtn.disabled = false;
      else payBtn.disabled = true;
    };

    function validateEmail(email) {
      return /\S+@\S+\.\S+/.test(email);
    }

    // Utility to escape single quotes in product names
    function escapeJsString(s) {
      return s.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
    }

    // Try to dynamically load SDK if not available
    function loadIntaSendSdk(timeout = 10000) {
      return new Promise((resolve, reject) => {
        if (window.IntaSend) {
          console.log("IntaSend SDK already present.");
          return resolve(true);
        }

        console.log("Attempting to dynamically load IntaSend SDK...");
        const script = document.createElement('script');
        script.src = "https://js.intasend.com/intasend-inline.js";
        script.async = true;

        const timer = setTimeout(() => {
          script.onerror = null;
          script.onload = null;
          reject(new Error("Timed out loading IntaSend SDK"));
        }, timeout);

        script.onload = () => {
          clearTimeout(timer);
          console.log("IntaSend SDK loaded dynamically.");
          resolve(true);
        };
        script.onerror = (err) => {
          clearTimeout(timer);
          reject(new Error("Failed to load IntaSend SDK"));
        };
        document.head.appendChild(script);
      });
    }

    // Main payment function with diagnostics & retries
    window.payWithIntaSend = async function(productName, priceUSD, index) {
      const statusEl = document.getElementById(`status-${index}`);
      statusEl.classList.add('hidden');
      statusEl.textContent = '';

      const emailInput = document.getElementById(`email-input-${index}`);
      const email = emailInput ? emailInput.value.trim() : '';
      if (!validateEmail(email)) {
        alert("Please enter a valid email address before proceeding.");
        return;
      }

      // Check SDK presence
      if (!window.IntaSend || typeof IntaSend.inline !== 'function') {
        console.warn("IntaSend.inline not available. Will attempt to load SDK dynamically.");
        try {
          await loadIntaSendSdk();
        } catch (err) {
          console.error("Could not load IntaSend SDK:", err);
          statusEl.textContent = "Payment service currently unavailable. Check console and network for intasend-inline.js.";
          statusEl.classList.remove('hidden');
          alert("Payment service unavailable. See console for details (F12).");
          return;
        }
      }

      // Final check
      if (!window.IntaSend || typeof IntaSend.inline !== 'function') {
        console.error("IntaSend.inline still not available after loading attempt.");
        statusEl.textContent = "Payment service unavailable (SDK missing).";
        statusEl.classList.remove('hidden');
        alert("Payment service is currently unavailable. Please try again later or contact support.");
        return;
      }

      // All set â€” call IntaSend.inline with try/catch
      const redirectURL = `${window.location.origin}/thank-you.html?product=${encodeURIComponent(productName)}&email=${encodeURIComponent(email)}`;

      try {
        console.log("Calling IntaSend.inline with:", { publicAPIKey: INTASEND_PUBLIC_KEY, amount: priceUSD, currency: "USD", email, redirectURL });
        IntaSend.inline({
          publicAPIKey: INTASEND_PUBLIC_KEY,
          amount: priceUSD,
          currency: "USD",
          email: email,
          redirectURL: redirectURL,
          metadata: { product: productName },
          onSuccess: function(response) {
            console.log("IntaSend onSuccess callback:", response);
            // SDK may redirect automatically; fallback:
            window.location.href = redirectURL;
          },
          onError: function(error) {
            console.error("IntaSend onError:", error);
            statusEl.textContent = "Payment failed: " + (error && error.message ? error.message : "Unknown error");
            statusEl.classList.remove('hidden');
            alert("Payment failed: " + (error && error.message ? error.message : "Unknown error"));
          }
        });
      } catch (err) {
        console.error("Exception while calling IntaSend.inline:", err);
        statusEl.textContent = "Payment failed to start: " + err.message;
        statusEl.classList.remove('hidden');
        alert("Payment failed to start. See console (F12) for details.");
      }
    };

    // Contact form handling
    window.addEventListener('DOMContentLoaded', function() {
      renderProducts();

      const contactForm = document.getElementById('contact-form');
      contactForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const status = document.getElementById('contact-status');
        status.textContent = "Thank you! We received your message and will reply soon.";
        status.classList.remove('hidden');
        contactForm.reset();
      });

      // Print quick diagnostic to console on load
      console.log("Page loaded. INTASEND_PUBLIC_KEY present?", !!window.INTASEND_PUBLIC_KEY, "IntaSend available?", !!window.IntaSend, "IntaSend.inline exists?", window.IntaSend && typeof window.IntaSend.inline === 'function');
    });
  </script>

  <!-- Include the diagnostic helper (after the page scripts) -->
  <script src="payment-diagnostic.js"></script>
</body>
</html>
